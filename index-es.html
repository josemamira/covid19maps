<!DOCTYPE html>
<html>
  <head>
    <meta charset='utf-8'>
    <meta http-equiv="X-UA-Compatible" content="chrome=1">
    <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">
    <link href='https://fonts.googleapis.com/css?family=Architects+Daughter' rel='stylesheet' type='text/css'>
    <link rel="stylesheet" type="text/css" href="stylesheets/stylesheet.css" media="screen">
    <link rel="stylesheet" type="text/css" href="stylesheets/github-light.css" media="screen">
    <link rel="stylesheet" type="text/css" href="stylesheets/print.css" media="print">
    <!--<link rel="stylesheet" type="text/css" href="css/font-awesome-4.7.0/css/font-awesome.min.css" media="print">-->
    <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/font-awesome/4.3.0/css/font-awesome.min.css">
    
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.6.0/dist/leaflet.css" integrity="sha512-xwE/Az9zrjBIphAcBb3F6JVqxf46+CDLwfLMHloNu6KEQCAWi6HcDUbeOfBIptF7tcCzusKFjFw2yuvEpDL9wQ==" crossorigin=""/>
	<script src="https://unpkg.com/leaflet@1.6.0/dist/leaflet.js" integrity="sha512-gZwIG9x3wUXg2hdXF6+rVkLF/0Vi9U8D2Ntg4Ga5I5BZpVkVxlJWbSQtXPSiUTtC0TjtGOmxa1AJPuV0CPthew==" crossorigin=""></script>
    <script src="src/js/jquery-3.2.1.min.js"></script>
    <script src="src/js/d3.v5.js" charset="utf-8"></script>
    <!-- control -->
	<script src="src/js/Leaflet.Control.Custom.js"></script>
    <!--[if lt IE 9]>
    <script src="//html5shiv.googlecode.com/svn/trunk/html5.js"></script>
    <![endif]-->
<style>
.info { width: auto !important; 
	padding: 6px 8px; 
	font: 14px/16px Arial, Helvetica, sans-serif; 
	background: white; 
	background: rgba(255,255,255,0.8); 
	box-shadow: 0 0 15px rgba(0,0,0,0.2); 
	border-radius: 5px; } 
.info h4 { margin: 0 0 5px; color: #777; }
.legend { text-align: left; line-height: 18px; color: #555; } 
.legend i { width: 18px; height: 18px; float: left; margin-right: 8px; opacity: 0.7; }
</style>
    <title>COVID-19 interactive maps by josemamira</title>
  </head>
 
  <body>
    <header>
      <div class="inner">
        <h1>COVID-19 interactive maps</h1>
        <h2></h2>
        <a href="https://github.com/josemamira/covid19maps" class="button"><small>View project on</small> GitHub</a>
      </div>
    </header>

    <div id="content-wrapper">
      <div class="inner clearfix">
        <section id="main-content">
          <h3>
<a id="welcome-to-github-pages" class="anchor" href="#welcome-to-github-pages" aria-hidden="true">
  <span aria-hidden="true" class="octicon octicon-link"></span></a>Bienvenido a COVID-19 interactive maps.</h3>
<a href="index.html">English version</a>
<p><img src="src/img/portada.png" width="80%"></p>
		
<p>Sí no quieres leer más y sólo quieres ver las demostraciones aquí las tienes listadas:</p>
<p>Con cartografía dinámica (se puede elegir la fecha):</p>
<ul>
   <li><a href="src/demo3_dotmap.html" target="_blank">Mapa de densidad de puntos (density map)</a></li>
   <li><a href="src/demo4_world.html" target="_blank">Mapa de infectados por países</a></li>
   <li><a href="src/demo4_world_1000.html" target="_blank">Mapa de infectados por cada 1000 habitantes (países)</a></li>
   <li><a href="src/demo4_world_100000.html" target="_blank">Mapa de infectados por cada 100.000 habitantes (países) + TOP10</a></li>
   <li><a href="src/time.html" target="_blank">Mapa de infectados por cada 100.000 habitantes (países) + TOP10 + animación</a></li>	
   <li><a href="src/demo4_world_deaths.html" target="_blank">Mapa de fallecidos por países</a></li>
   <li><a href="src/demo4_world_deaths_millon.html" target="_blank">Mapa de fallecidos por cada millón de habitantes (países)</a></li>
   <li><a href="src/demo4_spain.html" target="_blank">Mapa de infectados por Comunidades Autónomas</a></li>	
   <li><a href="src/demo5_graduated_symbol_covid.html" target="_blank">Mapa de símbolo graduado con infectados por países</a></li>	
</ul>	
		
<p>Con tablas:</p>
<ul>
   <li><a href="src/demo1_create_geojson_from_csv.html" target="_blank">Generar un GeoJSON en tiempo real</a></li>
   <li><a href="src/demo2_join_csv.html" target="_blank">Unir dos tablas en una sóla</a></li>	
</ul>		
		
<p>Con gráficas:</p>
<ul>
   <li><a href="src/demo6_bar_charts.html">Gráfica de barras con la evolución de los infectados por CCAA</a></li>	
</ul>	
		
<p>Dada la situación mundial en que nos encontramos (abril 2020), donde la población está confinada en sus viviendas (caso de España) he querido aprovechar 
el tiempo disponible para investigar sobre las posibilidades que ofrece la cartografía para ofrecer 
la información de una forma más atractiva que las frías tablas de cifras.</p>

<div id="map" style="width: 600px; height: 400px;"></div>

<p>El punto de partida de este proyecto era y es ofrecer a los desarrolladores la capacidad de mostrar cartografía en sus respectivos portales de una manera fácil y desatendida. Por ello la cartografía debía de cumplir los siguientes requerimientos:</p>
<ul>
	<li>Utilizar una API de mapas 100 % libre. En este sentido he optado por utilizar Leaflet como motor para publicar los mapas</li>
	<li>El resto de librerías Javascript utilizadas son también de dominio público, y muy extendido su uso por los desarrolladores. 
		Principalmente he utilizado: D3 y JQuery. 
		También he utilizado Turj.js, una excelente librería para el geoprocesamiento espacial en Javascrpit</li>
	<li>Los datos geográficos deberán estar en un formato también libre y extendido en el mundo de la geomática. En este sentido se 
		ha optado "GeoJSON". He utilizado 2 conjunto de datos muy simplificados, con pocos vértices, para que su carga sea 
		rápida </li>
	<li>Los datos estadísticos proceden de fuente públicas y abiertas, y están disponibles en formato CSV. 
	En ningún momento he descargado los datos para tratarlos. Estos se conectan por AJAX desde sus respectivos servidores, realizando online una unión entre columnas (JOIN en terminología GIS). 
	La actualización de los datos es por tanto la de estas fuentes. Hasta ahora (18 de abril 2020) ésta es diaria. 
	Las fuentes que he utilizado son:
		<ul>
			<li><a href="https://github.com/datadista/datasets/tree/master/COVID%2019">Datadista</a></li>
			<li><a href="https://github.com/CSSEGISandData">CSSE at Johns Hopkins University</a></li>
		</ul>
	</li>	
</ul>

          
          
<h2>
<a id="designer-templates" class="anchor" href="#designer-templates" aria-hidden="true">
  <span aria-hidden="true" class="octicon octicon-link"></span></a>Casos de estudio</h2>

<h3>
<a id="designer-templates" class="anchor" href="#designer-templates" aria-hidden="true">
  <span aria-hidden="true" class="octicon octicon-link"></span></a>Generación al vuelo de un GeoJSON a partir de un CSV con coordenadas</h3>

<p>Este ejemplo no contiene cartografía, pero muestra las capacidades para generar "al vuelo" un GeoJSON con todos los datos.</p>
<p>Si deseas ver el resultado puedes copiar el resultado al portapapeles y visualizarlo en el visor <a href="http://geojson.io/">http://geojson.io</a></p>
<img src="src/img/geojsoncsv.png">
<p><a href="src/demo1_create_geojson_from_csv.html" target="_blank"><button type="button" >demo <i class="fa fa-cogs fa-2" aria-hidden="true"></i></button></a> 
| 
<a href="https://github.com/josemamira/covid19maps/blob/master/src/demo1_create_geojson_from_csv.html" target="_blank"><button type="button" >código 
<i class="fa fa-github fa-2" aria-hidden="true"></i></button></a>
</p>





<h3>
<a id="designer-templates" class="anchor" href="#designer-templates" aria-hidden="true">
  <span aria-hidden="true" class="octicon octicon-link"></span></a>Unión de dos ficheros CSV (al vuelo) y generación de tabla HTML</h3>

<p>Este ejemplo tampoco contiene cartografía, pero muestra las capacidades para realizar una unión de dos tablas (CSV)
 que tienen en común el contenido de una columna (que no es lo mismo que el nombre de la columna). 
 Por ejemplo tenemos una tabla con un listado de unidades administrativas (por ejemplo municipios), con una columna con su código -en el caso de España es el código INE -. 
 Esta tabla se une con otra que también tiene una columna con ese código.</p>
 <img src="src/img/table.png">
<a href="src/demo2_join_csv.html" target="_blank"><button type="button" >demo <i class="fa fa-cogs fa-2" aria-hidden="true"></i></button></a> 
| 
<a href="https://github.com/josemamira/covid19maps/blob/master/src/demo2_join_csv.html" target="_blank"><button type="button" >código <i class="fa fa-github fa-2" aria-hidden="true"></i></button></a>



<h3>
<a id="designer-templates" class="anchor" href="#designer-templates" aria-hidden="true">
  <span aria-hidden="true" class="octicon octicon-link"></span></a>Mapa de densidad de puntos (density map)</h3>

<p>Este tipo de mapas ya no suelen ser muy habituales pero hay que reconocer que unido a su simpleza está la capacidad de comunicar claramente 
un fenómeno. Muchos hemos visto el típico mapa de puntos, donde un punto representa una determinada cantidad de elementos 
	(votos, cabeza de ganado, etc). 
Pues este ejemplo llevado al caso del COVID-19 nos da una idea de como un mismo dato (casos) cambia su interpretación en 
	función del número de elementos que identifican a un punto.
</p>
<video src="src/img/dotmap.mp4" width="768" height="576" autoplay muted loop controls></video>		
<p>Veamos un ejemplo de España, para valores de 200, 1000 y 5000 casos por punto.</p>
<p><img src="src/img/dotmap_spain.png"></p>
<p>Esta web dispone de un control deslizador (slider) para seleccionar el número de casos por cada punto. Está en la parte inferior izquierda.</p>
<p><img src="src/img/slider.png"></p>
<p>Para realizar esta función he utilizado la función de generar un punto en en polígono incluida en <a href="https://turfjs.org/">TurfJS</a></p>
<a href="src/demo3_dotmap.html" target="_blank">
	<button type="button" >demo <i class="fa fa-cogs fa-2" aria-hidden="true"></i></button>
</a> 
| 
<a href="https://github.com/josemamira/covid19maps/blob/master/src/demo3_dotmap.html" target="_blank"><button type="button" >código <i class="fa fa-github fa-2" aria-hidden="true"></i></button></a>


<h3>
<a id="designer-templates" class="anchor" href="#designer-templates" aria-hidden="true">
  <span aria-hidden="true" class="octicon octicon-link"></span></a>Mapa coroplético de una fecha elegida por el usuario</h3>
  <p><img src="src/img/coropletico_world.png" width="400"></p>
  <p>La idea que me inspiró para hacer este mapa es de nuevo la unión de ficheros, en este caso un CSV con los casos del COVID-19 con una GeoJSON de polígonos con los países. Quise aprovechar que en el fichero CSV 
  estaban recogidos todos los casos por países desde el inicio de los registros (22 de enero) hasta la actualidad, para añadir un combo desplegable 
  con las fechas para que el usuario puede ver la evolución de la pandemia.</p>  
  <p>Para que los datos sean comparativos entre fechas la leyenda es fija, por lo que en los primeros días da la sensación de que no ocurre nada</p>
  <p>También he querido incluir un gŕafico lineal sobre la evolución de la pandemia en cada país, activando el efecto cuando te posicionas 
  encima del elemento (hover), haciendo también uso de la excelente librería <a href="https://d3js.org/">D3.js</a>. </p>
  <p>Otra de la las utilidades que he añadido ha sido mostrar un listado con los <a href="src/demo4_world_1000.html">10 países</a> con mayor número de fallecidos por millón de habitantes</p>
  <p>Por último puedes disponer de un control de vídeo <i class="fa fa-play"></i> para poder ver una <a href="src/time.html">animación</a> de como he evolucionado la pandemia desde que se disponen de datos.</p> 
  
  <a href="src/demo4_world.html" target="_blank"><button type="button" >demo <i class="fa fa-cogs fa-2" aria-hidden="true"></i></button></a> 
  | <a href="https://github.com/josemamira/covid19maps/blob/master/src/demo4_world.html" target="_blank"><button type="button" >código <i class="fa fa-github fa-2" aria-hidden="true"></i></button></a>
  <br>
  <a href="src/demo4_world_1000.html" target="_blank"><button type="button" >demo casos por cada 1000 habitantes <i class="fa fa-cogs fa-2" aria-hidden="true"></i></button></a> 
  | <a href="https://github.com/josemamira/covid19maps/blob/master/src/demo4_world_1000.html" target="_blank"><button type="button" >código casos por cada 1000 habitantes<i class="fa fa-github fa-2" aria-hidden="true"></i></button></a>
  <br>
  <a href="src/time.html" target="_blank"><button type="button" >demo animación de la pandemia <i class="fa fa-cogs fa-2" aria-hidden="true"></i></button></a> 
  | <a href="https://github.com/josemamira/covid19maps/blob/master/src/time.html" target="_blank"><button type="button" >código animación de la pandemia<i class="fa fa-github fa-2" aria-hidden="true"></i></button></a>


<h3>
<a id="designer-templates" class="anchor" href="#designer-templates" aria-hidden="true">
  <span aria-hidden="true" class="octicon octicon-link"></span></a>Mapa coroplético por Comunidades Autónomas (España).</h3>
  <p>Es el mismo ejemplo que el anterior, con otra fuente de datos local y adscrita a otro nivel coroplético, en este ejemplo nos referimos a los afectados por 
  COVID-19 en cada Comunidad Autónoma</p>
  <p><img src="src/img/coropletico_spain.png"></p>
  <p>Por desgracia, como continúen el incremento de casos el mapa será monocolor, salvo que cambie el valor de los intervalos de clase.</p>
  <a href="src/demo4_spain.html" target="_blank"><button type="button" >demo <i class="fa fa-cogs fa-2" aria-hidden="true"></i></button></a> 
  | 
 <a href="https://github.com/josemamira/covid19maps/blob/master/src/demo4_spain.html" target="_blank"><button type="button" >código <i class="fa fa-github fa-2" aria-hidden="true"></i></button></a>

<h3>
<a id="designer-templates" class="anchor" href="#designer-templates" aria-hidden="true">
  <span aria-hidden="true" class="octicon octicon-link"></span></a>Mapa coroplético de fallecimientos por COVID-19 por países</h3>
  <p>Es el mismo ejemplo que el de los paises pero con los fallecimientos.</p>
  <p><img src="src/img/coropletico_world_deaths.png"></p>
  <p>Uno aspecto a destacar es que al poder utilizar las columnas de dos conjuntos de datos, se pueden crear campos calculados. En este caso, se puede ver en el gráfico como aparece la cifra de los 
  fallecimientos por millón de habitantes</p>
  <p>Otra de las utilidades es poder ver un listado con los <a href="src/demo4_world_deaths_millon.html">10 países</a> con mayor número de fallecidos por millón de habitantes.</p>
  <p>Finalmente podemos ver una <a href="src/time.html">animación</a> de como ha ido evolucionando la pandemia, utilizando el control video <i class="fa fa-play"></i></p>		
		
  <a href="src/demo4_world_deaths.html" target="_blank"><button type="button" >demo <i class="fa fa-cogs fa-2" aria-hidden="true"></i></button></a>   |
  <a href="https://github.com/josemamira/covid19maps/blob/master/src/demo4_world_deaths.html" target="_blank"><button type="button" >código <i class="fa fa-github fa-2" aria-hidden="true"></i></button></a>
<br>
<a href="src/demo4_world_deaths_millon.html" target="_blank"><button type="button" >demo fallecimientos cada millon habitantes<i class="fa fa-cogs fa-2" aria-hidden="true"></i></button></a> 
|  <a href="https://github.com/josemamira/covid19maps/blob/master/src/demo4_world_deaths_millon.html" target="_blank">
   <button type="button" >código fallecimientos millon hab <i class="fa fa-github fa-2" aria-hidden="true"></i></button></a>
<br>
   <a href="src/time.html" target="_blank"><button type="button" >demo animación fallecimientos cada millon habitantes<i class="fa fa-cogs fa-2" aria-hidden="true"></i></button></a> 
|  <a href="https://github.com/josemamira/covid19maps/blob/master/src/time.html" target="_blank">
   <button type="button" >código animación fallecimientos millon hab <i class="fa fa-github fa-2" aria-hidden="true"></i></button></a>	


<h3>
<a id="designer-templates" class="anchor" href="#designer-templates" aria-hidden="true">
  <span aria-hidden="true" class="octicon octicon-link"></span></a>Mapa de símbolo graduado</h3>
  <video src="src/img/evolucion_covid19.mp4" width="743" height="471" autoplay muted loop controls></video>
  <p>Sin lugar a dudas este es el mapa más impactante, donde podemos apreciar por fechas (slider en la parte inferior) como va evolucionando 
  los contactos, pero mostrados como un símbolo graduado.</p>
  <p>Quiero agradecer el interesante artículo "<a href="https://cartographicperspectives.org/index.php/journal/article/view/cp76-donohue-et-al/1307">Time Series Proportional Symbol Maps with Leaflet and jQuery</a> que me ha permitido realizar este mapa</p>

  <a href="src/demo5_graduated_symbol_covid.html" target="_blank"><button type="button" >demo <i class="fa fa-cogs fa-2" aria-hidden="true"></i></button></a> 
  | 
 <a href="https://github.com/josemamira/covid19maps/blob/master/src/demo5_graduated_symbol_covid.html" target="_blank"><button type="button" >código <i class="fa fa-github fa-2" aria-hidden="true"></i></button></a>


<h3>
<a id="designer-templates" class="anchor" href="#designer-templates" aria-hidden="true">
  <span aria-hidden="true" class="octicon octicon-link"></span></a>Múltiples gráficos de barras</h3>
  <p>Cada vez estoy más satisfecho con las posibilidades de la librería D3.js. Su capacidad para hacer 
     gráficos es increibles.</p>
<img src="src/img/graficos.png" width="800">
  <p>En este ejemplo utilizo los datos de un CSV con afectados de Covid-19 por Comunidades Autónomas (España) para 
     obtener un gráfico por cada una de ellas, incluyendo además diferenciación de barras por colores para facilitar 
     la interpretación del gráfico y de unificar valores.</p>
  <a href="src/demo6_bar_charts.html" target="_blank"><button type="button" >demo <i class="fa fa-cogs fa-2" aria-hidden="true"></i></button></a> 
  | 
 <a href="https://github.com/josemamira/covid19maps/blob/master/src/demo6_bar_charts.html" target="_blank"><button type="button" >código <i class="fa fa-github fa-2" aria-hidden="true"></i></button></a>

		
		
		

          
<h3>
<a id="creating-pages-manually" class="anchor" href="#creating-pages-manually" 
   aria-hidden="true"><span aria-hidden="true" class="octicon octicon-link"></span></a>Enlaces de interés</h3>

<p>Este proyecto utiliza las siguientes librerías JS o datos</p>
<ul>
  <li><a href="https://leafletjs.com/" target="_blank">Leaflet JS: excelente y sencilla API de mapas </a></li>
  <li><a href="https://turfjs.org/" target="_blank">TurJS: Geoprocesamiento espacial en Javascript</a></li>
  <li><a href="https://turfjs.org/" target="_blank">AlaSql: SQL for JSON data</a></li>	
  <li><a href="http://d3.org" target="_blank">Potente librería para manejo de datos y representación de gráficos</a></li>
  <li><a href="https://osm.org/" target="_blank">OpenStreetMap: Sin lugar a dudas el mapa libre más completo </a></li>
  <li><a href="https://lodash.com/" target="_blank">A modern JavaScript utility library delivering modularity, performance & extras</a></li>
  <li><a href="https://github.com/CSSEGISandData" target="_blank">Johns Hopkins University - Center for Systems Science and Engineering</a></li>
  <li><a href="https://github.com/datadista/datasets/tree/master/COVID%2019" target="_blank">Periodismo de investigación, datos y nuevas narrativas para salir del ruido</a></li>
</ul>
          
<h3>
<a id="authors-and-contributors" class="anchor" href="#authors-and-contributors" aria-hidden="true"
   ><span aria-hidden="true" class="octicon octicon-link"></span></a>Autor y contribuciones</h3>

<p>Los ejemplos de esta web han sido realizados por José Manuel Mira Martínez. Sí se ha utilizado código de otro proyecto libre en el código fuente aparece citado.</p>

<h3>
<a id="support-or-contact" class="anchor" href="#support-or-contact" aria-hidden="true">
  <span aria-hidden="true" class="octicon octicon-link"></span></a>Contacto</h3>

<p>Puedes ponerte en contacto en esta dirección de correo: <a href="mailto:josema.mira@gmail.com">josema.mira@gmail.com</a></p>
        </section>

        <aside id="sidebar">
          <a href="https://github.com/josemamira/covid19maps/archive/master.zip" class="button">
            <small>Download</small>
            .zip file
          </a>
          <a href="https://github.com/josemamira/covid19maps/tarball/master" class="button">
            <small>Download</small>
            .tar.gz file
          </a>

          <p class="repo-owner"><a href="https://github.com/josemamira/covid19maps"></a> is maintained by <a href="https://github.com/josemamira">josemamira</a>.</p>

          <p>This page was generated by <a href="https://pages.github.com">GitHub Pages</a> using the Architect theme by <a href="https://twitter.com/jasonlong">Jason Long</a>.</p>
        </aside>
      </div>
    </div>

<script type="text/javascript">

	var map = L.map('map').setView([0,0], 2);

	L.tileLayer('https://api.mapbox.com/styles/v1/{id}/tiles/{z}/{x}/{y}?access_token=pk.eyJ1IjoibWFwYm94IiwiYSI6ImNpejY4NXVycTA2emYycXBndHRqcmZ3N3gifQ.rJcFIG214AriISLbB6B5aw', {
		maxZoom: 18,
		attribution: 'Map data &copy; <a href="https://www.openstreetmap.org/">OpenStreetMap</a> contributors, ' +
			'<a href="https://creativecommons.org/licenses/by-sa/2.0/">CC-BY-SA</a>, ' +
			'Imagery © <a href="https://www.mapbox.com/">Mapbox</a>',
		id: 'mapbox/light-v9',
		tileSize: 512,
		zoomOffset: -1
	}).addTo(map);
	
	// Select fechas
	L.control.custom({
		position: 'topleft',
		content : '<div class="input-group">'+
					'<label for="exampleFormControlSelect1">Select a date: </label>'+
						'<select class="form-control" id="datesSel"><option>SELECT A DATE</option></select>'+
					'</div>',
		classes : '',
		style   :
		{
			position: 'absolute',
			left: '50px',
			top: '0px',
			width: '200px',
		},
	}).addTo(map);
            
            
	$('#datesSel').on('change', function() {
	  //alert( this.value );
	  restyleLayer(this.value);
	});
	// delete duplicates
	$( '#datesSel').focus(function() {
		var optionValues =[];
		$('#datesSel option').each(function(){
		   if($.inArray(this.value, optionValues) >-1){
			  $(this).remove()
		   }else{
			  optionValues.push(this.value);
		   }
		});
	});



	// control that shows state info on hover
	var info = L.control({position: 'bottomleft'});

	info.onAdd = function (map) {
		this._div = L.DomUtil.create('div', 'info');
		this.update();
		return this._div;
	};

	info.update = function (props) {
		obj = Object(props);
		//console.log(obj);
		//console.log( Object.entries(obj) );
		var keys = Object.keys(obj);
		// filtrado para quedarse solo con keys de fecha
		keys = keys.filter(key => key.substring(key.length - 3, key.length) == '/20'   );
		// obtener un array de valores de las fechas
		values =[]
		for (var i = 0; i < keys.length; i++) {
			values.push( Number(props[keys[i]]) );
		}
		
		var casos = [];
		for (var i = 0; i < keys.length; i++) {
			//var caso = {  date: keys[i],  value: values[i]	};
			var caso = {  date: d3.timeParse("%m/%d/%Y")(keys[i]),  value: values[i]	};
			casos.push(caso);
		}	

		lastDate = keys[keys.length - 1];
		this._div.innerHTML = '<h4>COVID-19</h4>' +  (props ?
			props.name +' cases every 1000 people:<strong> ' + (((Number(props[lastDate]))*1000)/props.pop).toFixed(2) + '</strong><br>'+
			'<div id="chart"></div>'
			: 'Hover over a country');
		//chart(values);
		lineChart(casos);
		
	};

	info.addTo(map);

  function lineChart(data) {
	  // set the dimensions and margins of the graph
		var margin = {top: 10, right: 30, bottom: 60, left: 60},
			width = 300 - margin.left - margin.right,
			height = 200 - margin.top - margin.bottom;

		// append the svg object to the body of the page
		var svg = d3.select("#chart")
		  .append("svg")
			.attr("width", width + margin.left + margin.right)
			.attr("height", height + margin.top + margin.bottom)
		  .append("g")
			.attr("transform",
				  "translate(" + margin.left + "," + margin.top + ")");
    // Add X axis --> it is a date format
    var x = d3.scaleTime()
      .domain(d3.extent(data, function(d) { return d.date; }))
      .range([ 0, width ]);
    svg.append("g")
      .attr("transform", "translate(0," + height + ")")            
      .call(d3.axisBottom(x))   
       .selectAll("text")
		.attr("y", 0)
		.attr("x", 9)
		.attr("dy", ".35em")
		.attr("transform", "rotate(90)")
		.style("text-anchor", "start") ;  

      
    // Add Y axis
    var y = d3.scaleLinear()
      .domain([0, d3.max(data, function(d) { return +d.value; })])
      .range([ height, 0 ]);
    svg.append("g")
      .call(d3.axisLeft(y));

    // Add the line
    svg.append("path")
      .datum(data)
      .attr("fill", "none")
      .attr("stroke", "steelblue")
      .attr("stroke-width", 1.5)
      .attr("d", d3.line()
        .x(function(d) { return x(d.date) })
        .y(function(d) { return y(d.value) })
        )

}





// http://bl.ocks.org/Andrew-Reid/11602fac1ea66c2a6d7f78067b2deddb
function chart(d) {
  //console.log('iniciando chart');
  //var feature = d.feature;
  //var data = feature.properties.data;
  data = d;
  var width = 300;
  var height = 100;
  var margin = {left:20,right:15,top:40,bottom:40};
  var parse = d3.timeParse("%m");
  var format = d3.timeFormat("%b");
   
  svg = d3.select("#chart");
  //var div = d3.create("div")
  var svg = d3.create("svg")
  //var svg = div.append("svg")
    .attr("width", width+margin.left+margin.right)
    .attr("height", height+margin.top+margin.bottom);
  var g = svg.append("g")
    .attr("transform","translate("+[margin.left,margin.top]+")");
    
  var y = d3.scaleLinear()
    .domain([0, d3.max(data, function(d) { return d; }) ])
    .range([height,0]);
    
  var yAxis = d3.axisLeft()
    .ticks(4)
    .scale(y);
  g.append("g").call(yAxis);
    
  var x = d3.scaleBand()
    .domain(d3.range(12))
    .range([0,width]);
    
  var xAxis = d3.axisBottom()
    .scale(x)
    .tickFormat(function(d) { return format(parse(d+1)); });
    
  g.append("g")
      .attr("transform", "translate(0," + height + ")")
      .call(xAxis)
      .selectAll("text")
      .attr("text-anchor","end")
      .attr("transform","rotate(-90)translate(-12,-15)")
    
  var rects = g.selectAll("rect")
    .data(data)
    .enter()
    .append("rect")
    .attr("y",height)
    .attr("height",0)
    .attr("width", x.bandwidth()-2 )
    .attr("x", function(d,i) { return x(i); })
    .attr("fill","steelblue")
    .transition()
    .attr("height", function(d) { return height-y(d); })
    .attr("y", function(d) { return y(d); })
    .duration(1000);
    
  var title = svg.append("text")
    .style("font-size", "20px")
    .text('hola')
    .attr("x", width/2 + margin.left)
    .attr("y", 30)
    .attr("text-anchor","middle");
    
  return svg;
    //console.log(svg);
}  
	
	
	// get color depending on population density value
	function getColor(d) {
		return d > 100000 ? '#800026' :
				d > 50000  ? '#BD0026' :
				d > 20000  ? '#E31A1C' :
				d > 10000  ? '#FC4E2A' :
				d > 5000   ? '#FD8D3C' :
				d > 2000   ? '#FEB24C' :
				d > 1000   ? '#FED976' :
							'#FFEDA0';
	}

	function style(feature) {
		return {
			weight: 2,
			opacity: 1,
			color: 'white',
			//dashArray: '3',
			fillOpacity: 0.7,
			fillColor: getColor(feature.properties.densidad)
		};
	}

	function highlightFeature(e) {
		var layer = e.target;

		layer.setStyle({
			weight: 2,
			//color: '#666', // color borde cuando el mouse está encima
			//dashArray: '',
			fillOpacity: 0.7
		});

		if (!L.Browser.ie && !L.Browser.opera && !L.Browser.edge) {
			layer.bringToFront();
		}

		info.update(layer.feature.properties);
	}

	//var geojson;

	function resetHighlight(e) {
		geojson.resetStyle(e.target);
		info.update();
	}

	function zoomToFeature(e) {
		map.fitBounds(e.target.getBounds());
	}

	function onEachFeature(feature, layer) {
		layer.on({
			mouseover: highlightFeature,
			//mouseout: resetHighlight,
			click: zoomToFeature
		});
	}
	
	//https://stackoverflow.com/questions/25773389/changing-the-style-of-each-feature-in-a-leaflet-geojson-layer
	function restyleLayer(propertyName) {

		geojson.eachLayer(function(layer) {
			propertyValue = layer.feature.properties[propertyName];

			// Your function that determines a fill color for a particular
			// property name and value.
			//var myFillColor = getColor(propertyName, propertyValue);
			var myFillColor = getColor(propertyValue);

			layer.setStyle({
				fillColor: myFillColor,
				fillOpacity: 0.8,
				weight: 0.5
			});
		});
	}

/*
	geojson = L.geoJson(statesData, {
		style: style,
		onEachFeature: onEachFeature
	}).addTo(map);

*/
	// Geojson from file
	// Cargar GeoJSON desde un archivo externo
	var geojson = L.geoJson(null, {
		style: style,
		onEachFeature: onEachFeature
	});
	
	var start = Date.now();

	url='src/data/countries_data.geojson'; 
	d3.json(url).then( function(data) {		 
	//d3.json(url, function(error, data) { // d3.v3
		urlcsv = 'https://raw.githubusercontent.com/CSSEGISandData/COVID-19/master/csse_covid_19_data/csse_covid_19_time_series/time_series_covid19_confirmed_global.csv';
		d3.csv(urlcsv).then( function(csv) {
		//d3.csv("data/covid19.csv", function(error, csv) {  /d3.v5
			var world = data.features;
			// Renombrar una columna
			csv = csv.map(function(obj) { 
				obj['name'] = obj['Country/Region']; // Assign new key 
				delete obj['Country/Region']; // Delete old key 
				return obj; 
			}); 

			csv.forEach(function(d, i) {
				//console.log(d);
				keys = Object.keys(d) ;
				// rellenar el combo quitando los que no son fecha
				cols = keys.filter(key => key.substring(key.length - 3, key.length) == '/20'   );				
				$('#datesSel').empty().append('<option selected="selected" value="nothing">(Select a date)</option>');
				cols.forEach(function(col) {
					if ( col.substring(col.length - 3, col.length) == '/20'   ) {	
						$('#datesSel').append($('<option><option/>').val(col).text(col)); 
					}
				});				
				
				// Join entre tablas por key name
				world.forEach(function(e, j) {
					if(e.properties.name === d.name && d['Province/State']=== '') {
						//console.log('coinciden');
						//e.properties= d;
						Object.assign(e.properties, d); // suma a las propiedades del geojson las del csv
					}
				})
			}); 
			
			geojson = L.geoJson(data, {
				style: style,
				onEachFeature: onEachFeature
			});
			geojson.addTo(map);
			//console.log(geojson);

		})
		
    });//.addTo(map);
    
	map.attributionControl.addAttribution('Develop by <a href="https://github.com/josemamira.io/covid19maps">Jose Manuel Mira</a> | Covid-19 data &copy; <a href="https://github.com/CSSEGISandData">CSSE at Johns Hopkins University</a>');

	var legend = L.control({position: 'bottomright'});

	legend.onAdd = function (map) {

		var div = L.DomUtil.create('div', 'info legend'),
			grades = [0, 1000, 2000, 5000, 10000, 20000, 50000, 100000],
			labels = [],
			from, to;

		for (var i = 0; i < grades.length; i++) {
			from = grades[i];
			to = grades[i + 1];

			labels.push(
				'<i style="background:' + getColor(from + 1) + '"></i> ' +
				from + (to ? '&ndash;' + to : '+'));
		}

		div.innerHTML = labels.join('<br>');
		return div;
	};

	legend.addTo(map);

function merge(arr1, arr2, prop1, prop2) {
    return arr1.map(function(item){
        var p = item[prop1];
        el = arr2.filter(function(item) {
            return item[prop2] === p;
        });
        if (el.length === 0) {
            return null;
        }
        var res = {};
        for (var i in item) {
            if (i !== prop1) {
                res[i] = item[i];
            }
        }
        for (var i in el[0]) {
            if (i !== prop2) {
                res[i] = el[0][i];
            }
        }
        return res;
    }).filter(function(el){
        return el !== null;
    });
}



</script>  
  </body>
</html>

